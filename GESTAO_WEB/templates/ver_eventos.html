{% extends "base.html" %}

{% block title %}Eventos de {{ cliente.nome }}{% endblock %}

{% block content %}
<style>
    .event-image {
        aspect-ratio: 16/9; object-fit: cover; background-color: #eee;
        cursor: pointer; transition: transform 0.2s ease-in-out;
    }
    .event-image:hover { transform: scale(1.03); }

    #modalImageContainer {
        overflow: hidden; cursor: grab; touch-action: none;
        display: flex; align-items: center; justify-content: center;
    }
    #modalImage {
        transition: transform 0.15s ease-out;
        transform-origin: center center;
        max-width: 100%; max-height: 100%;
    }
    .zoom-controls {
        display: flex; align-items: center; gap: 0.5rem;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-camera-reels"></i> Eventos de IA - {{ cliente.nome }}</h1>
    <a href="/cliente/{{ cliente.id }}" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> Voltar para o Cliente</a>
</div>

{% if not eventos_por_camera %}
<div class="text-center py-5 card"><div class="card-body">
    <p class="lead">Nenhum evento de detecção de IA foi encontrado.</p>
    <p class="text-muted">Verifique se a "Detecção de Objetos (IA)" está ativa nas câmeras.</p>
</div></div>
{% else %}
    {% for cam_nome, eventos in eventos_por_camera.items() %}
    <div class="card shadow-sm mb-4">
        <div class="card-header"><h5 class="mb-0"><i class="bi bi-camera-video"></i> Câmera: {{ cam_nome }}</h5></div>
        <div class="card-body"><div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3">
            {% for evento in eventos %}
            <div class="col"><div class="card h-100">
                <img src="{{ evento.url }}" class="card-img-top event-image"
                     alt="Snapshot do evento"
                     data-image-url="{{ evento.url }}"
                     data-image-title="Evento: {{ evento.objeto | capitalize }} em {{ evento.data }} às {{ evento.hora }}"
                     loading="lazy">
                <div class="card-body p-2">
                    <p class="card-text mb-1"><i class="bi bi-tag"></i> <strong>{{ evento.objeto | capitalize }}</strong></p>
                    <p class="card-text small text-muted"><i class="bi bi-calendar-event"></i> {{ evento.data }} <i class="bi bi-clock ms-1"></i> {{ evento.hora }}</p>
                </div>
            </div></div>
            {% endfor %}
        </div></div>
    </div>
    {% endfor %}
{% endif %}

<!-- Modal Final com Controles de Zoom -->
<div class="modal fade" id="imageViewerModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="imageViewerModalLabel">Visualizador de Evento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-0" id="modalImageContainer">
        <img id="modalImage" src="" alt="Imagem do Evento">
      </div>
      <div class="modal-footer d-flex justify-content-between">
         <a id="downloadButton" href="#" download class="btn btn-success"><i class="bi bi-download"></i> Baixar</a>
         <div class="zoom-controls">
            <button id="zoomOutBtn" class="btn btn-secondary btn-sm"><i class="bi bi-zoom-out"></i></button>
            <input type="range" id="zoomSlider" class="form-range" min="1" max="5" step="0.1" value="1" style="width: 150px;">
            <button id="zoomInBtn" class="btn btn-secondary btn-sm"><i class="bi bi-zoom-in"></i></button>
         </div>
         <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const modalEl = document.getElementById('imageViewerModal');
    const imageViewerModal = new bootstrap.Modal(modalEl);
    const modalImageContainer = document.getElementById('modalImageContainer');
    const modalImage = document.getElementById('modalImage');
    const downloadButton = document.getElementById('downloadButton');
    const zoomSlider = document.getElementById('zoomSlider');
    const zoomInBtn = document.getElementById('zoomInBtn');
    const zoomOutBtn = document.getElementById('zoomOutBtn');

    let scale = 1, isPanning = false, start = { x: 0, y: 0 }, translate = { x: 0, y: 0 };

    function applyTransform() {
        const containerRect = modalImageContainer.getBoundingClientRect();
        const imageRect = modalImage.getBoundingClientRect();
        const maxTranslateX = (imageRect.width * scale - containerRect.width) / 2;
        const maxTranslateY = (imageRect.height * scale - containerRect.height) / 2;

        translate.x = Math.max(-maxTranslateX, Math.min(maxTranslateX, translate.x));
        translate.y = Math.max(-maxTranslateY, Math.min(maxTranslateY, translate.y));

        modalImage.style.transform = `translate(${translate.x}px, ${translate.y}px) scale(${scale})`;
    }

    function updateZoom(newScale) {
        scale = Math.max(1, Math.min(5, newScale));
        zoomSlider.value = scale;
        applyTransform();
    }

    function resetZoom() {
        translate = { x: 0, y: 0 };
        updateZoom(1);
    }

    document.querySelectorAll('.event-image').forEach(image => {
        image.addEventListener('click', function () {
            modalImage.src = this.dataset.imageUrl;
            document.getElementById('imageViewerModalLabel').textContent = this.dataset.imageTitle;
            downloadButton.href = this.dataset.imageUrl;
            downloadButton.download = `evento_${new Date().toISOString().split('T')[0]}.jpg`;
            resetZoom();
            imageViewerModal.show();
        });
    });

    modalImageContainer.addEventListener('wheel', e => {
        e.preventDefault();
        updateZoom(scale - e.deltaY * 0.005);
    }, { passive: false });

    modalImageContainer.addEventListener('mousedown', e => {
        if (scale > 1) {
            e.preventDefault();
            isPanning = true;
            start = { x: e.clientX - translate.x, y: e.clientY - translate.y };
            modalImageContainer.style.cursor = 'grabbing';
        }
    });

    window.addEventListener('mousemove', e => {
        if (isPanning) {
            e.preventDefault();
            translate.x = e.clientX - start.x;
            translate.y = e.clientY - start.y;
            applyTransform();
        }
    });

    window.addEventListener('mouseup', () => {
        if (isPanning) {
            isPanning = false;
            modalImageContainer.style.cursor = 'grab';
        }
    });

    zoomSlider.addEventListener('input', e => updateZoom(parseFloat(e.target.value)));
    zoomInBtn.addEventListener('click', () => updateZoom(scale + 0.2));
    zoomOutBtn.addEventListener('click', () => updateZoom(scale - 0.2));
    modalEl.addEventListener('hidden.bs.modal', resetZoom);
});
</script>

<!-- VIDEO_BTN_MODAL_BOOTSTRAP_START -->
<script>
(function(){
  function ensureModal(){
    let modalEl = document.getElementById('eventVideoModal');
    if(modalEl) return modalEl;
    modalEl = document.createElement('div');
    modalEl.id = 'eventVideoModal';
    modalEl.className = 'modal fade';
    modalEl.tabIndex = -1;
    modalEl.innerHTML = `
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Vídeo do Evento</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body p-0">
            <video id="eventVideoPlayer" class="w-100" controls preload="metadata"></video>
            <small id="eventVideoHint" class="text-muted d-block px-3 mt-2"></small>
          </div>
        </div>
      </div>`;
    document.body.appendChild(modalEl);
    modalEl.addEventListener('hidden.bs.modal', ()=>{
      const v=document.getElementById('eventVideoPlayer');
      v.pause(); v.removeAttribute('src'); v.load();
    });
    return modalEl;
  }

  function toPath(u){ try { return new URL(u, location.origin).pathname } catch(_) { return u; } }

  async function resolveFromApi(jpg){
    try{
      const r = await fetch('/api/event-video?jpg=' + encodeURIComponent(toPath(jpg)));
      if(!r.ok) return null;
      const d = await r.json();
      return d && d.url ? d.url : null;
    }catch(e){ return null; }
  }

  window.openEventVideo = async function(jpg){
    const modalEl = ensureModal();
    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    const player = modalEl.querySelector('#eventVideoPlayer');
    const hint = modalEl.querySelector('#eventVideoHint');

    let url = await resolveFromApi(jpg);
    if(!url){ url = toPath(jpg).replace('/FRIGATE/','/media_files/FRIGATE/').replace('.jpg','.mp4'); }

    player.src = url; player.load(); hint.textContent = url;
    modal.show();
  };

  // injeta botão Bootstrap nos cards
  document.querySelectorAll('.event-image').forEach(img=>{
    const body = img.closest('.card')?.querySelector('.card-body');
    if(!body || body.querySelector('[data-ver-video]')) return;
    const btn = document.createElement('button');
    btn.type='button'; btn.dataset.verVideo='1';
    btn.className='btn btn-outline-primary w-100 mt-2';
    btn.textContent='Ver vídeo';
    btn.addEventListener('click', ()=>openEventVideo(img.getAttribute('src')));
    body.appendChild(btn);
    // atalho: duplo clique na imagem
    img.addEventListener('dblclick', (e)=>{ e.preventDefault(); openEventVideo(img.getAttribute('src')); });
  });
})();
</script>
<!-- VIDEO_BTN_MODAL_BOOTSTRAP_END -->

{% endblock %}

<!-- ========== Modal de Vídeo de Evento (injetado) ========== -->
<!-- ========== Fim do bloco de vídeo de evento ========== -->

